# PRD：换班预定与结算系统（MVP）

## 1. 目标与范围
- 面向船代代理的换班下单与后台结算管理。
- 目标：快速下单（≤30秒）、线下执行信息准确、月结对账闭环。
- 范围：前台换班下单（含历史订单导入/修改）、后台审核派车、服务中管理、服务完成后费用录入与月度结算。

## 2. 用户角色
- 代理用户（前台下单者）
- 后台运营（审核、派车、结算）

## 3. 前台（代理下单）

### 3.1 流程
1) 代理验证（手机号/邮箱白名单）  
2) 换班下单（关键字段）  
3) 复核与提交  
4) 订单列表（历史订单 & 编辑）  

### 3.2 换班下单页面（Step1）
核心必填
- 人数
- 车辆数（支持自动估算）
- 接送类型：机场/港口
- 接送时间
- 集合点
- 目的地（支持类型选择）
- 航班号（机场）
- 船名+船号（港口）

可选
- 接驳识别（领队称呼/标识）
- 船员国籍（多国籍输入）
- 可选信息折叠区：行李/需求、其他要求、酒店、用餐

目的地类型
- 酒店 / 码头 / 其他  
  - 码头：下拉选择固定列表  
  - 酒店/其他：自由输入  
  - 校验：码头必须选，其他需填写

历史订单导入
- 显示最近3单
- 点击“导入”自动填充当前表单

### 3.3 复核与提交（Step2）
- 展示代理信息、人数/车辆、接送详情、集合点、目的地、国籍、可选需求
- 预估费用总价（可展开明细）
- 月结条款勾选
- 按钮：提交 / 复制派单文本（微信文本）

### 3.4 订单列表（Step4）
- 显示订单状态：审核中 / 服务中 / 已完成
- 仅审核中可修改订单
- 服务中 / 已完成不可修改（按钮置灰）

## 4. 后台（结算与执行）

### 4.1 订单流转
状态流转不可回退：
1) 审核中（review）  
2) 服务中（in_service）  
3) 已完成（completed）  

规则：
- 审核通过时必须录入司机信息（必填）
- 服务中可修改司机信息 & 上传保险
- 已完成后才允许录入实际费用与票据
- 仅后台可变更状态，前台只读状态
- 状态变更记录审核人/审核时间

权限与前置条件（MVP）
- 审核通过：司机姓名/联系方式/车牌/座位数必填
- 标记完成：仅状态为服务中可执行
- 费用录入：仅状态为已完成可操作（未完成时只读提示）

### 4.2 审核与派车（后台详情）
必填
- 司机姓名  
- 联系方式  
- 车牌号  
- 座位数  

选填
- 车型/车辆备注  
- 保险附件（可随时上传，多份保单）  

审核通过按钮
- 条件：司机必填项齐全  
- 动作：记录审核人/审核时间，状态变为服务中

附件规则（MVP）
- 支持多份保单上传
- 单文件限制：不超过10MB
- 支持类型：图片/ PDF
- 已上传可删除/替换

### 4.3 服务中
- 可更新司机信息
- 可上传/修改保险

### 4.4 服务完成
- 后台按钮：标记服务完成
- 之后允许实际费用录入

### 4.5 实际费用录入
- 只在“已完成”可录入
- 分两步结构：
  1. 执行事实（车/酒店/餐饮细节）
  2. 费用与票据（每条非零费用必须上传票据）
- 支持额外收费项目
- 票据上传时机：仅已完成后开放

### 4.6 月度结算
- 月度汇总：预估/实际总额
- 账单状态：草稿 → 已确认 → 已开票 → 已收款
- 无票据/无实际费用时禁止进入确认/开票/收款

## 5. 数据结构（核心字段）

订单 ShiftOrder
- id, createdAt
- agentContactType, agentContactValue
- agencyCompanyId, billingAccountId
- status: review | in_service | completed
- driver: name, phone, plate, seats, vehicleType
- insuranceAttachments: []
- audit: approvedBy, approvedAt
- data:
  - groupSize, carCount
  - transferType, transferDateTime
  - airportFlightNumber | portVesselName | portVesselNumber
  - pickupPoint, pickupIdentifier, pickupTerminal, pickupGate
  - destination, destinationType
  - crewNationalities
  - needHotel, hotelName, hotelNights
  - needMeal, mealPlan, mealCount
  - luggageNotes, specialRequests
  - notes

## 6. 校验规则（关键）
- 必填：人数、车辆数、接送类型、接送时间、集合点、目的地  
- 机场必须填航班号  
- 港口必须填船名+船号  
- 审核通过必须填司机姓名/联系方式/车牌/座位数  
- 实际费用录入需每条非零费用上传票据  

## 7. 交互与文案要点
- 关键字段前置
- 可选信息折叠
- 微信派单文本一键复制
- 状态不可回退

派单文本模板（微信）
派单信息（换班）
人数/车辆：X人 · X车
接送类型：接机/接船
接送时间：YYYY-MM-DD HH:mm
集合点：xxx
接驳识别：xxx（可空）
航班号/船名船号（按类型显示）
目的地：xxx（酒店/码头/其他）
酒店：xxx · X晚（不需要则标注）
餐饮：标准/品质 · X人（不需要则标注）
船员国籍：多国籍列表
行李/需求：可空
备注：可空

## 8. 订单修改规则（前台）
- 仅“审核中”可修改
- 修改后保留原订单 ID 与创建时间
- 修改会重新计算预估费用与明细
- 修改不改变订单状态（仍为审核中）
- 服务中/已完成显示只读提示

## 9. 码头列表来源
- MVP 使用本地静态列表（与目的地类型“码头”下拉一致）
- 后续可切换为后台可配置

## 10. 异常处理（MVP）
- 航班/船号变更：仅审核中可改；服务中需线下沟通后由后台更新司机备注
- 取消订单：MVP 不支持取消，需线下处理
